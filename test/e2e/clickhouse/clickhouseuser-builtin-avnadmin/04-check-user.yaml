apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      decode_b64() {
        if [ -z "$1" ]; then
          return 0
        fi
        printf '%s' "$1" | base64 -d 2>/dev/null || true
      }

      timeout=600
      while [ $timeout -gt 0 ]; do
        actual_host="$(decode_b64 "$(kubectl --namespace "$NAMESPACE" get secret avnadmin-user-secret -o jsonpath='{.data.CLICKHOUSEUSER_HOST}' 2>/dev/null || true)")"
        actual_port="$(decode_b64 "$(kubectl --namespace "$NAMESPACE" get secret avnadmin-user-secret -o jsonpath='{.data.CLICKHOUSEUSER_PORT}' 2>/dev/null || true)")"
        actual_username="$(decode_b64 "$(kubectl --namespace "$NAMESPACE" get secret avnadmin-user-secret -o jsonpath='{.data.CLICKHOUSEUSER_USERNAME}' 2>/dev/null || true)")"

        if [ -n "$actual_host" ] && [ -n "$actual_port" ] && [ "$actual_username" = "avnadmin" ]; then
          echo "Username matches expected built-in user 'avnadmin'"
          exit 0
        fi

        echo "Waiting for secret/avnadmin-user-secret to be populated..."
        sleep 5
        timeout=$((timeout - 5))
      done

      if [ -n "${actual_username:-}" ] && [ "${actual_username:-}" != "avnadmin" ]; then
        echo "Username mismatch: expected 'avnadmin', got '${actual_username}'"
      else
        echo "Timeout waiting for secret/avnadmin-user-secret to be populated"
      fi
      kubectl --namespace "$NAMESPACE" get clickhouseuser avnadmin -o yaml || true
      kubectl --namespace "$NAMESPACE" describe secret avnadmin-user-secret || true
      exit 1
