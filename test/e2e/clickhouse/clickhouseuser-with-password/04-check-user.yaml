apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      decode_b64() {
        if [ -z "$1" ]; then
          return 0
        fi
        printf '%s' "$1" | base64 -d 2>/dev/null || true
      }

      expected_password="MyCustomPassword123!"
      timeout=600
      while [ $timeout -gt 0 ]; do
        actual_host="$(decode_b64 "$(kubectl --namespace "$NAMESPACE" get secret passworduser-secret -o jsonpath='{.data.CLICKHOUSEUSER_HOST}' 2>/dev/null || true)")"
        actual_port="$(decode_b64 "$(kubectl --namespace "$NAMESPACE" get secret passworduser-secret -o jsonpath='{.data.CLICKHOUSEUSER_PORT}' 2>/dev/null || true)")"
        actual_username="$(decode_b64 "$(kubectl --namespace "$NAMESPACE" get secret passworduser-secret -o jsonpath='{.data.CLICKHOUSEUSER_USERNAME}' 2>/dev/null || true)")"
        actual_password="$(decode_b64 "$(kubectl --namespace "$NAMESPACE" get secret passworduser-secret -o jsonpath='{.data.CLICKHOUSEUSER_PASSWORD}' 2>/dev/null || true)")"

        if [ -n "$actual_host" ] && [ -n "$actual_port" ] && [ -n "$actual_username" ] && [ "$actual_password" = "$expected_password" ]; then
          echo "✓ All required secret fields are present"
          echo "✓ Password matches predefined value"
          exit 0
        fi

        echo "Waiting for secret/passworduser-secret to be populated..."
        sleep 5
        timeout=$((timeout - 5))
      done

      if [ -n "${actual_password:-}" ] && [ "${actual_password:-}" != "$expected_password" ]; then
        echo "✗ Password mismatch: expected '${expected_password}', got '${actual_password}'"
      else
        echo "✗ Timeout waiting for secret/passworduser-secret to be populated"
      fi
      kubectl --namespace "$NAMESPACE" get clickhouseuser passworduser -o yaml || true
      kubectl --namespace "$NAMESPACE" describe secret passworduser-secret || true
      exit 1
