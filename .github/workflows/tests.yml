name: tests

on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:
    inputs:
      test_tags:
        description: Test tags to run (space-separated, e.g. 'postgresql kafka mysql'). Leave empty for all tests.
        required: false
        type: string
        default: ""
  workflow_call:
    inputs:
      pr_number:
        description: PR number to post results to (optional)
        required: false
        type: string
      notify_slack:
        description: Send Slack notifications
        required: false
        type: boolean
        default: false
      test_tags:
        description: Test tags to run (space-separated, e.g. 'postgresql kafka mysql'). Leave empty for all tests.
        required: false
        type: string
        default: ""
    secrets:
      AIVEN_TOKEN:
        required: true
      AIVEN_ACCOUNT_ID:
        required: true
      AIVEN_PROJECT_NAME_PREFIX:
        required: true
      SLACK_WEBHOOK_URL:
        required: false
      SLACK_CHANNEL:
        required: false

jobs:
  setup_aiven_project_suffix:
    runs-on: ubuntu-latest
    outputs:
      project_name_suffix: ${{ steps.selproj.outputs.project_name_suffix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - run: make selproj

      - id: selproj
        run: echo "project_name_suffix=$(make -s ci-selproj | tr -d '\n')" >> $GITHUB_OUTPUT
        env:
          AIVEN_TOKEN: ${{ secrets.AIVEN_TOKEN }}
          AIVEN_PROJECT_NAME_PREFIX: ${{ secrets.AIVEN_PROJECT_NAME_PREFIX }}

  post-initial-comment:
    runs-on: ubuntu-latest
    if: inputs.pr_number != ''
    outputs:
      comment_id: ${{ steps.comment.outputs.comment_id }}
    steps:
      - name: Post initial comment to PR
        id: comment
        uses: actions/github-script@v8
        with:
          script: |
            const testTags = '${{ inputs.test_tags }}';
            const tagsInfo = testTags ? `\n\n **Test Tags:** \`${testTags}\`` : '\n\nÔ∏è **Test Tags:** All tests';

            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.pr_number }}'),
              body: `## Running Acceptance Tests\n\nTriggered by @${context.actor}\n\n‚è≥ **Status:** Running...${tagsInfo}\n\nüîó **Workflow:** [View Progress](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });

            core.setOutput('comment_id', comment.data.id);

  find_tests:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.find_tests.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
      - uses: arduino/setup-task@v2
        with:
          version: 3.x
      - id: find_tests
        run: |
          output=$(task find-test-tags TAGS="${{ inputs.test_tags }}")
          echo "$output" >> $GITHUB_OUTPUT

  validate_matrix:
    needs: find_tests
    runs-on: ubuntu-latest
    steps:
      - name: Check if matrix is empty
        run: |
          matrix='${{ needs.find_tests.outputs.matrix }}'
          if [ "$matrix" = "[]" ]; then
            echo "Error: No matching test tags found!"
            exit 1
          fi

  test:
    needs: [setup_aiven_project_suffix, find_tests, validate_matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        name: ${{ fromJson(needs.find_tests.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - run: make test-tag tag=${{ matrix.name }}
        env:
          AIVEN_DEBUG: ${{ vars.AIVEN_DEBUG || 'false' }}
          ENABLE_DEBUG_LOGGING: ${{ vars.ENABLE_DEBUG_LOGGING || 'false' }}
          AIVEN_TOKEN: ${{ secrets.AIVEN_TOKEN }}
          AIVEN_ACCOUNT_ID: ${{ secrets.AIVEN_ACCOUNT_ID }}
          AIVEN_PROJECT_NAME: >-
            ${{ secrets.AIVEN_PROJECT_NAME_PREFIX }}${{ needs.setup_aiven_project_suffix.outputs.project_name_suffix }}

  sweep:
    if: always()
    needs: [setup_aiven_project_suffix, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - run: make sweep
        env:
          AIVEN_TOKEN: ${{ secrets.AIVEN_TOKEN }}
          AIVEN_ACCOUNT_ID: ${{ secrets.AIVEN_ACCOUNT_ID }}
          AIVEN_PROJECT_NAME: >-
            ${{ secrets.AIVEN_PROJECT_NAME_PREFIX }}${{ needs.setup_aiven_project_suffix.outputs.project_name_suffix }}

  update-pr-comment:
    if: always() && inputs.pr_number != ''
    needs: [setup_aiven_project_suffix, post-initial-comment, test, sweep]
    runs-on: ubuntu-latest
    steps:
      - name: Update PR comment with results
        uses: actions/github-script@v8
        with:
          script: |
            const testResult = '${{ needs.test.result }}';

            const success = testResult === 'success';
            const emoji = success ? '‚úÖ' : '‚ùå';
            const status = success ? 'Passed' : 'Failed';

            const body = `## ${emoji} Acceptance Tests ${status}\n\n**Workflow:** [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ needs.post-initial-comment.outputs.comment_id }},
              body: body
            });

  notify-slack-success:
    if: always() && needs.test.result == 'success' && (github.event_name == 'schedule' || inputs.notify_slack)
    needs: [test, sweep]
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: success
      workflow_name: tests
      custom_message: All acceptance tests passed
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}

  notify-slack-failure:
    if: failure() && needs.test.result != 'success' && (github.event_name == 'schedule' || inputs.notify_slack)
    needs: [test, sweep]
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: failure
      workflow_name: tests
      custom_message: Acceptance tests failed
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
